<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Insurance Broker Management System</title>
    <link rel="stylesheet" href="https://nordcdn.net/ds/css/3.3.1/nord.min.css"
        integrity="sha384-x2XdCI8Yog7KGRmrrGLegjFrrIYXEhGNxql/xEXdMoW5NkpEhlAkUHdQJxkL1vPg" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://nordcdn.net/ds/themes/8.1.1/nord-dark.css"
        integrity="sha384-4mfQkitA1YUssjHukrfVhopnhPw9eM2tX8Z05rZ/5NJRmDJN1fQp2gGfwydx2SzL" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/styles.css">
    <script type="module" src="https://nordcdn.net/ds/components/3.18.2/index.js"
        integrity="sha384-Hxzh12RVoHTpU2FOGZp+/nJxzuDRDoLKCpOMahxaYjmeImNHJJFhconKw3OjRkDd"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
</head>

<body>

    <nord-layout>
        <nord-navigation slot="nav">
            <nord-nav-group heading="Workspace">
                <nord-nav-item id="dashboardNavItem" href="#" active
                    icon="navigation-dashboard">Dashboard</nord-nav-item>
                <nord-nav-item icon="navigation-payments">
                    Policies
                    <nord-nav-group slot="subnav">
                        <nord-nav-item href="#" id="createPolicyNavItem">Create New Policy</nord-nav-item>
                        <nord-nav-item href="#" id="assignPolicyNavItem">Assign Policy</nord-nav-item>
                        <nord-nav-item href="#" id="viewPoliciesNavItem">View Policies</nord-nav-item>
                    </nord-nav-group>
                </nord-nav-item>
                <nord-nav-item icon="user-single">
                    Users
                    <nord-nav-group slot="subnav">
                        <nord-nav-item icon="user-add" href="#" id="addUserNavItem">Add New User</nord-nav-item>
                        <nord-nav-item icon="user-edit" href="#" id="viewEditUserNavItem">View/Edit
                            Users</nord-nav-item>
                    </nord-nav-group>
                </nord-nav-item>
            </nord-nav-group>
            <nord-dropdown expand slot="footer">
                <nord-button slot="toggle" expand>
                    <nord-avatar slot="start" aria-hidden="true" name="brokerName"></nord-avatar>
                    Laura Williams
                </nord-button>
                <nord-dropdown-group>
                    <nord-dropdown-item href="#">View profile</nord-dropdown-item>
                    <nord-dropdown-item>Settings</nord-dropdown-item>
                </nord-dropdown-group>
                <nord-dropdown-item>
                    Sign out
                    <nord-icon slot="end" name="interface-logout"></nord-icon>
                </nord-dropdown-item>
            </nord-dropdown>
        </nord-navigation>
        <nord-header slot="header">
            <h1 class="n-typescale-l">Dashboard</h1>
            <nord-tooltip id="export" position="block-end"> Export data as Spreadsheet </nord-tooltip>
        </nord-header>
        <nord-stack gap="l">
            <nord-card id="dashboard">
                <nord-banner variant="info">
                    Welcome to the Insurance Broker Management System. You can create/update policies, assign policies
                    to
                    users, add new users, view/edit users, and view policies.
                </nord-banner>
                <nord-card class="n-margin-bs-l">
                    <h2 slot="header">Quick Stats</h2>
                    <nord-stack gap="m" direction="horizontal">
                        <nord-card>
                            <h3 slot="header">Total Policies</h3>
                            <p slot="footer">10</p>
                        </nord-card>
                        <nord-card>
                            <h3 slot="header">Total Users</h3>
                            <p slot="footer">5</p>
                        </nord-card>
                    </nord-stack>
                </nord-card>
            </nord-card>
            <nord-card id="createPolicyCard">
                <h2 slot="header">Create/Update Policy</h2>
                <form id="createPolicyForm" action="PolicyController" method="POST">
                    <nord-input label="Policy Name" name="policyName" id="policyName" required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Policy Type" name="policyType" id="policyType"
                        required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Policy Premium" name="premium" id="premium"
                        required></nord-input>
                    <input type="hidden" name="action" id="formAction" value="create">
                    <nord-button class="n-margin-bs-l" type="submit" variant="primary" id="submitPolicyButton">Create
                        Policy</nord-button>
                </form>
            </nord-card>

            <nord-card id="assignPolicyCard" style="display: none;">
                <h2 slot="header">Assign Policy</h2>
                <form id="assignPolicyForm" action="PolicyController" method="POST">
                    <nord-input label="Select Policy" name="policy" required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Assign To" name="assignedTo" required></nord-input>
                    <input type="hidden" name="action" value="assign">
                    <nord-button class="n-margin-bs-l" type="submit" variant="primary">Assign Policy</nord-button>
                </form>
            </nord-card>

            <nord-card id="addUserCard" style="display: none;">
                <h2 slot="header">Add New User</h2>
                <form id="addUserForm" action="/addUser" method="POST">
                    <nord-input label="Username" name="username" required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Email" name="email" required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Role" name="role" required></nord-input>
                    <nord-button class="n-margin-bs-l" type="submit" variant="primary">Add User</nord-button>
                </form>
            </nord-card>

            <nord-card id="viewEditUserCard" style="display: none;">
                <h2 slot="header">View/Edit Users</h2>
                <div id="userList">
                    <nord-banner variant="info">User list will be displayed here.</nord-banner>
                </div>
            </nord-card>

            <nord-card id="viewPoliciesCard" style="display: none;">
                <h2 slot="header">View Policies</h2>
                <table id="policyTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Policy Name</th>
                            <th>Policy Type</th>
                            <th>Premium</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="policyList">

                    </tbody>
                </table>
            </nord-card>
        </nord-stack>
    </nord-layout>

    <script>

        const layout = document.querySelector("nord-layout");
        const commandMenu = document.querySelector("nord-command-menu");

        const dashboardNavItem = document.getElementById("dashboardNavItem");
        const createPolicyNavItem = document.getElementById("createPolicyNavItem");
        const assignPolicyNavItem = document.getElementById("assignPolicyNavItem");
        const addUserNavItem = document.getElementById("addUserNavItem");
        const viewEditUserNavItem = document.getElementById("viewEditUserNavItem");
        const viewPoliciesNavItem = document.getElementById("viewPoliciesNavItem");

        const dashboardCard = document.getElementById("dashboard");
        const createPolicyCard = document.getElementById("createPolicyCard");
        const assignPolicyCard = document.getElementById("assignPolicyCard");
        const addUserCard = document.getElementById("addUserCard");
        const viewEditUserCard = document.getElementById("viewEditUserCard");
        const viewPoliciesCard = document.getElementById("viewPoliciesCard");

        document.addEventListener("DOMContentLoaded", () => {
            toggleDisplay("dashboard");
        });

        const toggleDisplay = (cardToShow) => {
            dashboardCard.style.display = cardToShow === "dashboard" ? "block" : "none";
            createPolicyCard.style.display = cardToShow === "createPolicyCard" ? "block" : "none";
            assignPolicyCard.style.display = cardToShow === "assignPolicyCard" ? "block" : "none";
            addUserCard.style.display = cardToShow === "addUserCard" ? "block" : "none";
            viewEditUserCard.style.display = cardToShow === "viewEditUserCard" ? "block" : "none";
            viewPoliciesCard.style.display = cardToShow === "viewPoliciesCard" ? "block" : "none";
        };

        const toggleNavItem = (navItem) => {
            dashboardNavItem.active = false;
            createPolicyNavItem.active = false;
            assignPolicyNavItem.active = false;
            addUserNavItem.active = false;
            viewEditUserNavItem.active = false;
            viewPoliciesNavItem.active = false;

            navItem.active = true;
        };

        dashboardNavItem.addEventListener("click", () => {
            toggleDisplay("dashboard");
            toggleNavItem(dashboardNavItem);
        })

        createPolicyNavItem.addEventListener("click", () => {
            toggleDisplay("createPolicyCard");
            toggleNavItem(createPolicyNavItem);
            resetPolicyForm();
        });

        assignPolicyNavItem.addEventListener("click", () => {
            toggleDisplay("assignPolicyCard");
            toggleNavItem(assignPolicyNavItem);
        });

        addUserNavItem.addEventListener("click", () => {
            toggleDisplay("addUserCard");
            toggleNavItem(addUserNavItem);
        });

        viewEditUserNavItem.addEventListener("click", () => {
            toggleDisplay("viewEditUserCard");
            toggleNavItem(viewEditUserNavItem);
        });

        viewPoliciesNavItem.addEventListener("click", () => {
            toggleDisplay("viewPoliciesCard");
            toggleNavItem(viewPoliciesNavItem);
            loadPolicies();
        });

        const loadPolicies = () => {
            $.ajax({
                url: 'PolicyController?action=view',
                method: 'GET',
                success: (data) => {
                    const policyList = document.getElementById("policyList");
                    policyList.innerHTML = "";
                    data.forEach(({ policyId, policyName, policyType, premium }) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                    <td>${policyName}</td>
                    <td>${policyType}</td>
                    <td>${premium}</td>
                    <td>
                        <nord-button variant="secondary" onclick="openUpdatePolicy('${policyId}', '${policyName}', '${policyType}', ${premium})">Update</nord-button>
                        <nord-button variant="danger" onclick="deletePolicy('${policyId}')">Delete</nord-button>
                    </td>
                `;
                        policyList.appendChild(row);
                    });

                    $('#policyTable').DataTable();
                },
                error: (error) => {
                    console.error("Error loading policies:", error);
                }
            });
        };

        const openUpdatePolicy = (policyId, policyName, policyType, premium) => {
            document.getElementById("policyName").value = policyName;
            document.getElementById("policyType").value = policyType;
            document.getElementById("premium").value = premium;
            document.getElementById("formAction").value = "update";
            document.getElementById("submitPolicyButton").innerText = "Update Policy";

            toggleDisplay("createPolicyCard");
        };

        document.getElementById("createPolicyForm").addEventListener("submit", (event) => {
            event.preventDefault();
            const action = document.getElementById("formAction").value;
            const policyName = document.getElementById("policyName").value;
            const policyType = document.getElementById("policyType").value;
            const premium = document.getElementById("premium").value;

            $.ajax({
                url: `PolicyController?action=${action}`,
                method: 'POST',
                data: {
                    policyName,
                    policyType,
                    premium
                },
                success: () => {
                    alert(`Policy ${action === "create" ? "created" : "updated"} successfully.`);
                    loadPolicies();
                    resetPolicyForm();
                },
                error: (error) => {
                    console.error(`Error ${action === "create" ? "creating" : "updating"} policy:`, error);
                }
            });
        });

        const resetPolicyForm = () => {
            document.getElementById("policyName").value = "";
            document.getElementById("policyType").value = "";
            document.getElementById("premium").value = "";
            document.getElementById("formAction").value = "create";
            document.getElementById("submitPolicyButton").innerText = "Create Policy";
        };

        const deletePolicy = (policyId) => {
            if (confirm("Are you sure you want to delete this policy?")) {
                $.ajax({
                    url: `PolicyController?action=delete&id=${policyId}`,
                    method: 'POST',
                    success: () => {
                        alert("Policy deleted successfully.");
                        loadPolicies();
                    },
                    error: (error) => {
                        console.error("Error deleting policy:", error);
                    }
                });
            }
        };


    </script>

</body>

</html>