<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Insurance Broker Management System</title>
    <link rel="stylesheet" href="https://nordcdn.net/ds/css/3.3.1/nord.min.css"
        integrity="sha384-x2XdCI8Yog7KGRmrrGLegjFrrIYXEhGNxql/xEXdMoW5NkpEhlAkUHdQJxkL1vPg" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://nordcdn.net/ds/themes/8.1.1/nord-dark.css"
        integrity="sha384-4mfQkitA1YUssjHukrfVhopnhPw9eM2tX8Z05rZ/5NJRmDJN1fQp2gGfwydx2SzL" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/styles.css">
    <script type="module" src="https://nordcdn.net/ds/components/3.18.2/index.js"
        integrity="sha384-Hxzh12RVoHTpU2FOGZp+/nJxzuDRDoLKCpOMahxaYjmeImNHJJFhconKw3OjRkDd"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        table.dataTable thead th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }


        table.dataTable tbody tr {
            background-color: #f2f2f2;
        }


        table.dataTable tbody tr td {
            color: #333;
        }

        table.dataTable tbody tr:hover {
            background-color: #ddd;
        }
    </style>
</head>

<body>

    <nord-layout>
        <nord-navigation slot="nav">
            <nord-nav-group heading="Workspace">
                <nord-nav-item id="dashboardNavItem" href="#" active
                    icon="navigation-dashboard">Dashboard</nord-nav-item>
                <nord-nav-item icon="navigation-payments">
                    Policies
                    <nord-nav-group slot="subnav">
                        <nord-nav-item href="#" id="createPolicyNavItem">Create New Policy</nord-nav-item>
                        <nord-nav-item href="#" id="assignPolicyNavItem">Assign Policy</nord-nav-item>
                        <nord-nav-item href="#" id="viewPoliciesNavItem">View Policies</nord-nav-item>
                    </nord-nav-group>
                </nord-nav-item>
                <nord-nav-item icon="user-single">
                    Users
                    <nord-nav-group slot="subnav">
                        <nord-nav-item icon="user-add" href="#" id="addUserNavItem">Add New User</nord-nav-item>
                        <nord-nav-item icon="user-edit" href="#" id="viewEditUserNavItem">View/Edit
                            Users</nord-nav-item>
                    </nord-nav-group>
                </nord-nav-item>
                <nord-nav-item icon="interface-payment-terminal">
                    Claims
                    <nord-nav-group slot="subnav">
                        <nord-nav-item icon="interface-add" href="#" id="submitNewClaim">Submit New
                            Claim</nord-nav-item>
                        <nord-nav-item icon="interface-edit" href="#" id="updateClaim">Update
                            Claim</nord-nav-item>
                        <nord-nav-item icon="interface-checked" href="#" id="approveOrRejectClaim">Approve/Reject
                            Claim</nord-nav-item>
                        <nord-nav-item icon="interface-edit-on" href="#" id="viewClaimStatus">View Claim
                            Status</nord-nav-item>
                    </nord-nav-group>
                </nord-nav-item>
            </nord-nav-group>
            <nord-dropdown expand slot="footer">
                <nord-button slot="toggle" expand>
                    <nord-avatar slot="start" aria-hidden="true" name="brokerName"></nord-avatar>
                    Laura Williams
                </nord-button>
                <nord-dropdown-group>
                    <nord-dropdown-item href="#">View profile</nord-dropdown-item>
                    <nord-dropdown-item>Settings</nord-dropdown-item>
                </nord-dropdown-group>
                <nord-dropdown-item>
                    Sign out
                    <nord-icon slot="end" name="interface-logout"></nord-icon>
                </nord-dropdown-item>
            </nord-dropdown>
        </nord-navigation>
        <nord-header slot="header">
            <h1 class="n-typescale-l">Dashboard</h1>
            <nord-tooltip id="export" position="block-end"> Export data as Spreadsheet </nord-tooltip>
        </nord-header>
        <nord-stack gap="l">
            <nord-card id="dashboard">
                <nord-banner variant="info">
                    Welcome to the Insurance Broker Management System. You can create/update policies, assign policies
                    to
                    users, add new users, view/edit users, and view policies.
                </nord-banner>
                <nord-card class="n-margin-bs-l">
                    <h2 slot="header">Quick Stats</h2>
                    <section class="n-grid-2">
                        <nord-card>
                            <h3 slot="header">Total Policies</h3>
                            <p slot="footer">10</p>
                        </nord-card>
                        <nord-card>
                            <h3 slot="header">Total Users</h3>
                            <p slot="footer">5</p>
                        </nord-card>
                        <nord-card>
                            <h3 slot="header">Total Claims</h3>
                            <p slot="footer">5</p>
                        </nord-card>
                        <nord-card>
                            <h3 slot="header">Approval Rate</h3>
                            <p slot="footer">5</p>
                        </nord-card>
                        <nord-card>
                            <h3 slot="header">Rejection Rate</h3>
                            <p slot="footer">5</p>
                        </nord-card>
                    </section>
                </nord-card>
            </nord-card>
            <!-- Create New Policy Card -->
            <nord-card id="createPolicyCard">
                <h2 slot="header">Create/Update Policy</h2>
                <form id="createPolicyForm" action="PolicyController" method="POST">
                    <nord-input label="Policy Name" name="policyName" id="policyName" required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Policy Type" name="policyType" id="policyType"
                        required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Policy Premium" name="premium" id="premium"
                        required></nord-input>
                    <input type="hidden" name="action" id="formAction" value="create">
                    <nord-button class="n-margin-bs-l" type="submit" variant="primary" id="submitPolicyButton">Create
                        Policy</nord-button>
                </form>
            </nord-card>

            <!-- Assign Policy Card -->
            <nord-card id="assignPolicyCard" style="display: none;">
                <h2 slot="header">Assign Policy</h2>
                <form id="assignPolicyForm" action="PolicyController" method="POST">
                    <nord-input label="Select Policy" name="policy" required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Assign To" name="assignedTo" required></nord-input>
                    <input type="hidden" name="action" value="assign">
                    <nord-button class="n-margin-bs-l" type="submit" variant="primary">Assign Policy</nord-button>
                </form>
            </nord-card>

            <!-- Add New User Card -->
            <nord-card id="addUserCard" style="display: none;">
                <h2 slot="header">Add New User</h2>
                <form id="addUserForm" action="CustomerController" method="POST">
                    <nord-input label="Username" name="username" required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Email" name="email" required></nord-input>
                    <nord-input class="n-margin-bs-l" label="Phone" name="phone" required></nord-input>
                    <input type="hidden" name="action" value="add">
                    <nord-button class="n-margin-bs-l" type="submit" variant="primary">Add User</nord-button>
                </form>
            </nord-card>

            <!-- View/Edit Users Card -->
            <nord-card id="viewEditUserCard" style="display: none;">
                <h2 slot="header">View/Edit Users</h2>
                <div>
                    <table id="userTable" class="display">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerList">

                        </tbody>
                    </table>
                </div>
            </nord-card>
            <nord-card id="editUserCard" style="display: none;">
                <h2 slot="header">Edit User</h2>
                <form id="editUserForm" action="CustomerController" method="POST">
                    <nord-input label="Username" name="username" required></nord-input>
                    <nord-input label="Email" name="email" required></nord-input>
                    <nord-input label="Phone Number" name="phone"></nord-input>
                    <input type="hidden" name="userId">
                    <input type="hidden" name="action" value="edit">
                    <nord-button type="submit" variant="primary">Save Changes</nord-button>
                </form>
            </nord-card>


            <!-- View Policies Card -->
            <nord-card id="viewPoliciesCard" style="display: none;">
                <h2 slot="header">View Policies</h2>
                <table id="policyTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Policy Name</th>
                            <th>Policy Type</th>
                            <th>Premium</th>
                            <th>Actions</th> <!-- Added Actions Column -->
                        </tr>
                    </thead>
                    <tbody id="policyList">
                        <!-- Policies will be populated here -->
                    </tbody>
                </table>
            </nord-card>
        </nord-stack>
    </nord-layout>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            toggleDisplay("dashboardCard");
        });

        const elements = {
            layout: document.querySelector("nord-layout"),
            dashboardNavItem: document.getElementById("dashboardNavItem"),
            createPolicyNavItem: document.getElementById("createPolicyNavItem"),
            assignPolicyNavItem: document.getElementById("assignPolicyNavItem"),
            addUserNavItem: document.getElementById("addUserNavItem"),
            viewEditUserNavItem: document.getElementById("viewEditUserNavItem"),
            viewPoliciesNavItem: document.getElementById("viewPoliciesNavItem"),
            dashboardCard: document.getElementById("dashboard"),
            createPolicyCard: document.getElementById("createPolicyCard"),
            assignPolicyCard: document.getElementById("assignPolicyCard"),
            addUserCard: document.getElementById("addUserCard"),
            viewEditUserCard: document.getElementById("viewEditUserCard"),
            viewPoliciesCard: document.getElementById("viewPoliciesCard"),
            submitNewClaim: document.getElementById("submitNewClaim"),
            updateClaim: document.getElementById("updateClaim"),
            approveOrRejectClaim: document.getElementById("approveOrRejectClaim"),
            viewClaimStatus: document.getElementById("viewClaimStatus")
        };

        const toggleDisplay = (cardToShow) => {
            const cards = [
                "dashboardCard",
                "createPolicyCard",
                "assignPolicyCard",
                "addUserCard",
                "viewEditUserCard",
                "viewPoliciesCard"
            ];
            cards.forEach(card => elements[card].style.display = card === `${cardToShow}` ? "block" : "none");
        };

        const toggleNavItem = (activeItem) => {
            Object.keys(elements).forEach(item => {
                if (item.includes("NavItem")) elements[item].active = item === activeItem;
            });
        };

        Object.entries({
            dashboardNavItem: "dashboardCard",
            createPolicyNavItem: "createPolicyCard",
            assignPolicyNavItem: "assignPolicyCard",
            addUserNavItem: "addUserCard",
            viewEditUserNavItem: "viewEditUserCard",
            viewPoliciesNavItem: "viewPoliciesCard"
        }).forEach(([navItem, card]) => {
            elements[navItem].addEventListener("click", () => {
                toggleDisplay(card);
                toggleNavItem(navItem);
                if (card === "createPolicyCard") resetPolicyForm();
                if (card === "viewEditUserCard") fetchUsers();
                if (card === "viewPoliciesCard") loadPolicies();
            });
        });

        const loadPolicies = async () => {
            try {
                const { data } = await $.ajax({
                    url: 'PolicyController?action=view',
                    method: 'GET'
                });
                const policyList = document.getElementById("policyList");
                policyList.innerHTML = data.map(({ policyId, policyName, policyType, premium }) => `
            <tr>
                <td>${policyName}</td>
                <td>${policyType}</td>
                <td>${premium}</td>
                <td>
                    <nord-button variant="secondary" onclick="openUpdatePolicy('${policyId}', '${policyName}', '${policyType}', ${premium})">Update</nord-button>
                    <nord-button variant="danger" onclick="deletePolicy('${policyId}')">Delete</nord-button>
                </td>
            </tr>
        `).join("");
                $('#policyTable').DataTable();
            } catch (error) {
                console.error("Error loading policies:", error);
            }
        };

        const openUpdatePolicy = (policyId, policyName, policyType, premium) => {
            Object.assign(document.getElementById("policyForm"), {
                policyName: { value: policyName },
                policyType: { value: policyType },
                premium: { value: premium },
                formAction: { value: "update" },
                submitPolicyButton: { innerText: "Update Policy" }
            });
            toggleDisplay("createPolicyCard");
        };

        document.getElementById("createPolicyForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            const { value: action } = document.getElementById("formAction");
            const policyName = document.getElementById("policyName").value;
            const policyType = document.getElementById("policyType").value;
            const premium = document.getElementById("premium").value;

            try {
                await $.ajax({
                    url: `PolicyController?action=${action}`,
                    method: 'POST',
                    data: { policyName, policyType, premium }
                });
                alert(`Policy ${action === "create" ? "created" : "updated"} successfully.`);
                loadPolicies();
                resetPolicyForm();
            } catch (error) {
                console.error(`Error ${action === "create" ? "creating" : "updating"} policy:`, error);
            }
        });

        const resetPolicyForm = () => {
            Object.assign(document.getElementById("policyForm"), {
                policyName: { value: "" },
                policyType: { value: "" },
                premium: { value: "" },
                formAction: { value: "create" },
                submitPolicyButton: { innerText: "Create Policy" }
            });
        };

        const deletePolicy = async (policyId) => {
            if (confirm("Are you sure you want to delete this policy?")) {
                try {
                    await $.ajax({
                        url: `PolicyController?action=delete&id=${policyId}`,
                        method: 'POST'
                    });
                    alert("Policy deleted successfully.");
                    loadPolicies();
                } catch (error) {
                    console.error("Error deleting policy:", error);
                }
            }
        };

        const fetchUsers = async () => {
            try {
                const response = await fetch('CustomerController');
                const data = await response.json();
                displayUsers(data);
            } catch (error) {
                console.error('Error fetching users:', error);
            }
        };

        const displayUsers = (users) => {
            const customerList = $('#customerList');
            customerList.empty();
            if (!users.length) {
                customerList.append('<nord-banner variant="info">No users found.</nord-banner>');
                return;
            }

            users.forEach(({ id, name = 'N/A', email = 'N/A', phone = 'N/A' }) => {
                const userItem = `
            <tr>
                <td>${name}</td>
                <td>${email}</td>
                <td>${phone}</td>
                <td>
                    <nord-button variant="secondary" id="editUser-${id}" onclick="editUser('${id}', '${name}', '${email}', '${phone}')">Edit</nord-button>
                    <nord-button variant="danger" id="deleteUser-${id}" onclick="deleteUser('${id}')">Delete</nord-button>
                </td>
            </tr>`;
                customerList.append(userItem);
            });
            $('#userTable').DataTable({
                destroy: true,
                paging: true,
                searching: true,
                ordering: true,
                info: false
            });
        };

        const editUser = (userId, name, email, phone) => {
            toggleDisplay("editUserCard");
            Object.assign(document.getElementById('editUserForm'), {
                username: { value: name },
                email: { value: email },
                phone: { value: phone },
                userId: { value: userId }
            });
        };

        const deleteUser = async (userId) => {
            if (confirm("Are you sure you want to delete this user?")) {
                try {
                    const response = await fetch(`CustomerController?action=delete&userId=${userId}`, { method: 'POST' });
                    const result = await response.json();
                    alert(result.success ? 'User deleted successfully' : 'Error deleting user');
                    fetchUsers();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('An error occurred. Please try again.');
                }
            }
        };

        const assignPolicy = async (userId, userEmail) => {
            try {
                const response = await fetch(`PolicyController?action=assign&policyNo=${userId}&assignTo=${userEmail}`, { method: 'POST' });
                const result = await response.json();
                alert(result.success ? 'Policy Assigned successfully' : 'Error assigning policy');
                fetchUsers();
            } catch (error) {
                console.error('Error assigning policy:', error);
                alert('An error occurred. Please try again.');
            }
        };

    </script>

</body>

</html>